<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

    <!-- flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <!-- Bootstrap JSï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã«å¿…è¦ï¼‰-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- flatpickr åˆæœŸåŒ– -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        <!-- flatpickr.localize(flatpickr.l10ns.ja); -->
        flatpickr.localize(flatpickr.l10ns.ja);
        flatpickr("#birth", {
          dateFormat: "Y-m-d",
          maxDate: "today"
        });
      });
    </script>

    <style>
      body {
        background: #f5f2fa;
        font-family: "Helvetica Neue", sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 640px;
        background: #ffffff;
        padding: 2rem;
        margin: 2rem auto;
        border-radius: 1rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }
      h2 {
        font-weight: bold;
        color: #5c4b8a;
        font-size: 1.8rem;
        text-align: center;
      }
      .form-label {
        font-weight: 500;
        font-size: 1rem;
      }
      .form-control,
      .form-select {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
      }
      .btn-purple {
        background-color: #9b59b6;
        border: none;
        color: white;
        font-size: 1.2rem;
        padding: 0.9rem;
        border-radius: 0.5rem;
      }
      .btn-purple:hover {
        background-color: #8e44ad;
        color: #ffe8b5;
      }
      #result {
        white-space: pre-wrap;
        min-height: 4em;
        font-size: 1rem;
      }
      .alert-custom {
        background: #fdf8f3;
        border-radius: 0.75rem;
        border: 1px solid #e6ddd5;
        padding: 1.25rem;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2 class="mb-4">-- ä»Šé€±ã®ã‚ãªãŸ --</h2>

      <div class="mb-3">
        <label for="lastName" class="form-label">å§“</label>
        <input type="text" id="lastName" class="form-control" placeholder="ä¾‹ï¼šå±±ç”°" />
      </div>

      <div class="mb-3">
        <label for="firstName" class="form-label">å</label>
        <input type="text" id="firstName" class="form-control" placeholder="ä¾‹ï¼šèŠ±å­" />
      </div>

      <div class="mb-3">
        <label for="birth" class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
        <input type="text" id="birth" class="form-control" placeholder="ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ" />
      </div>

      <div class="mb-3">
        <label for="gender" class="form-label">æ€§åˆ¥</label>
        <select id="gender" class="form-select">
          <option value="å¥³æ€§">å¥³æ€§</option>
          <option value="ç”·æ€§">ç”·æ€§</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <button onclick="runUranai()" class="btn btn-purple w-100">è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

      <div id="result" class="mt-4 alert alert-custom"></div>
    </div>

    <!-- å ã„ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
      let pendingKanji = "";
      let retryFlag = false;
      let submitBtnRegistered = false;

      function runUranai() {

        lastName= document.getElementById("lastName").value.trim();
        firstName= document.getElementById("firstName").value.trim();
        birth= document.getElementById("birth").value.trim();
        gender= document.getElementById("gender").value.trim();

        const resultBox = document.getElementById("result");
        if (!resultBox) {
          console.error("âš ï¸ #result è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          return;
        }
        // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
        if (!lastName || !firstName || !birth) {
          resultBox.innerText = "âš ï¸ å§“ãƒ»åãƒ»ç”Ÿå¹´æœˆæ—¥ã¯ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          return;
        }
        resultBox.innerText = "å ã„ä¸­â€¦ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„â³";

        const data ={
          lastName,
          firstName,
          birth,
          gender
        }

        google.script.run
          .withSuccessHandler(function (response) {
            console.log("ğŸ” response:", response);
            if (typeof response === "object" && response.success === false) {
              if (response.type === "missingKanji") {
                pendingKanji = response.kanji;
                document.getElementById("kanjiPrompt").innerText = `æ¼¢å­—ã€Œ${pendingKanji}ã€ã®ç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š`;
                document.getElementById("kanjiStrokeInput").value = "";

                const modal = new bootstrap.Modal(document.getElementById("kanjiModal"));
                modal.show();
              } else {
                resultBox.innerText = `âš ï¸ ${response.message}`;
              }
            } else {
              resultBox.innerText = response;
            }
          })
          .withFailureHandler(function (error) {
            console.error("å ã„ã‚¨ãƒ©ãƒ¼:", error);
            resultBox.innerText = "ã†ã¾ãå ã„ãŒã§ãã¾ã›ã‚“ã§ã—ãŸğŸ’¦ ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          })
          .getUranaiResult(data);

          if (!submitBtnRegistered) {
            document.getElementById("submitKanjiBtn").addEventListener("click", function () {
              const strokes = parseInt(document.getElementById("kanjiStrokeInput").value, 10);
              const errorMsg = document.getElementById("strokeErrorMsg");

              if (!isNaN(strokes) && strokes > 0) {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                if (errorMsg) errorMsg.classList.add("d-none");

                google.script.run
                  .withSuccessHandler(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById("kanjiModal"));
                    modal.hide();
                    runUranai(); // å†è¨ºæ–­
                  })
                  .recordMissingKakusuu(pendingKanji, strokes);
              } else {
                if (errorMsg) {
                  errorMsg.innerText = "æœ‰åŠ¹ãªç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                  errorMsg.classList.remove("d-none");
                } else {
                  alert("æœ‰åŠ¹ãªç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); // å¿µã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }
              }
            });
            submitBtnRegistered = true;
          }
      }
    </script>

    <!-- æœªç™»éŒ²æ¼¢å­—ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="kanjiModal" tabindex="-1" aria-labelledby="kanjiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="kanjiModalLabel">æœªç™»éŒ²ã®æ¼¢å­—ãŒã‚ã‚Šã¾ã™</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
          </div>
          <div class="modal-body">
            <p id="kanjiPrompt"></p>
            <input type="number" id="kanjiStrokeInput" class="form-control" placeholder="ç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
            <!-- ğŸ”½ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ -->
            <div id="strokeErrorMsg" class="alert alert-danger mt-2 d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn btn-primary" id="submitKanjiBtn">é€ä¿¡ã—ã¦å†è¨ºæ–­</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
