<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

    <!-- flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <!-- Bootstrap JSï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã«å¿…è¦ï¼‰-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- CSSèª­ã¿è¾¼ã¿ -->
    <?!= HtmlService.createHtmlOutputFromFile('style').getContent(); ?>


    <!-- flatpickr åˆæœŸåŒ– -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // flatpickr ã®æ—¥æœ¬èªãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºã‚’æœ‰åŠ¹åŒ–ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹ã«
        // flatpickr.localize(flatpickr.l10ns.ja);

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸè¡¨ç¤ºã§ 2000å¹´1æœˆ1æ—¥ã«ã‚¸ãƒ£ãƒ³ãƒ—ã•ã›ã‚‹ä¾‹
        flatpickr("#birth", {
          dateFormat: "Y-m-d",
          maxDate: "today",
          onReady: function (selectedDates, dateStr, fp) {
            fp.currentYear = 2000;
            fp.currentMonth = 0; // 0 ãŒ 1æœˆ
            fp.jumpToDate(new Date(2000, 0, 1));
          }
        });
  });
    </script>
  </head>

  <body>
    <div class="container">
      <h2 class="mb-4">-- ä»Šé€±ã®ã‚ãªãŸ --</h2>

      <div class="mb-3">
        <label for="lastName" class="form-label">å§“</label>
        <input type="text" id="lastName" class="form-control" placeholder="ä¾‹ï¼šå±±ç”°" />
      </div>

      <div class="mb-3">
        <label for="firstName" class="form-label">å</label>
        <input type="text" id="firstName" class="form-control" placeholder="ä¾‹ï¼šèŠ±å­" />
      </div>

      <div class="mb-3">
        <label for="birth" class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
        <input type="text" id="birth" class="form-control" placeholder="ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ" />
      </div>

      <div class="mb-3">
        <label for="gender" class="form-label">æ€§åˆ¥</label>
        <select id="gender" class="form-select">
          <option value="å¥³æ€§">å¥³æ€§</option>
          <option value="ç”·æ€§">ç”·æ€§</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <form id="uranai-form">
        <!-- åŒæ„ãƒã‚§ãƒƒã‚¯ -->
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="consent-check">
          <label class="form-check-label" for="consent-check">
            <a href="https://50blog.org/lp/fortune-privacy/" target="_blank">å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</a>ã«åŒæ„ã—ã¾ã™
          </label>
        </div>

        <!-- è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <div style="text-align: center;">
          <button type="submit" id="start-btn" class="btn btn-primary mt-3" disabled>
            è¨ºæ–­ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹
          </button>
        </div>
      </form>

      <div id="result" class="mt-4 alert alert-custom"></div>

      <!-- è¨ºæ–­çµæœã‚¨ãƒªã‚¢ã®ç›´ä¸‹ã«PDFãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
      <button id="downloadPdfBtn" class="btn btn-outline-secondary mt-3 d-none">ğŸ“„ çµæœã‚’PDFã§ä¿å­˜</button>

    </div>

    <!-- åŒæ„ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const checkbox = document.getElementById("consent-check");
        const startBtn = document.getElementById("start-btn");
        const form = document.getElementById("uranai-form");

        // âœ… åŒæ„ãƒã‚§ãƒƒã‚¯ã§ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
        checkbox.addEventListener("change", function () {
          startBtn.disabled = !checkbox.checked;
        });

        // âœ… è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ã‚’å®Ÿè¡Œï¼ˆrunUranaiå‘¼ã³å‡ºã—ï¼‰
        form.addEventListener("submit", function (e) {
          e.preventDefault(); // â† ã“ã‚Œã§ãƒªãƒ­ãƒ¼ãƒ‰é˜²æ­¢

          runUranai(); // â† ã“ã‚ŒãŒé‡è¦ï¼
        });
      });
    </script>

    <!-- å ã„ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
      let pendingKanji = "";
      let retryFlag = false;
      let submitBtnRegistered = false;

      function runUranai() {

        lastName= document.getElementById("lastName").value.trim();
        firstName= document.getElementById("firstName").value.trim();
        birth= document.getElementById("birth").value.trim();
        gender= document.getElementById("gender").value.trim();

        const resultBox = document.getElementById("result");
        if (!resultBox) {
          console.error("âš ï¸ #result è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          return;
        }
        // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
        if (!lastName || !firstName || !birth) {
          resultBox.innerText = "âš ï¸ å§“ãƒ»åãƒ»ç”Ÿå¹´æœˆæ—¥ã¯ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          return;
        }
        resultBox.innerText = "å ã„ä¸­â€¦ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„â³";

        const data ={
          lastName,
          firstName,
          birth,
          gender
        }
        google.script.run
          .withSuccessHandler(function (response) {
            console.log("ğŸ” response:", response);
            if (typeof response === "object" && response.success === false) {
              if (response.type === "missingKanji") {
                pendingKanji = response.kanji;
                document.getElementById("kanjiPrompt").innerText = `æ¼¢å­—ã€Œ${pendingKanji}ã€ã®ç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š`;
                document.getElementById("kanjiStrokeInput").value = "";

                const modal = new bootstrap.Modal(document.getElementById("kanjiModal"));
                modal.show();
              } else {
                resultBox.innerText = `âš ï¸ ${response.message}`;
              }
            } else {
              // resultBox.innerText = response;
              const resultBox = document.getElementById("result");
              resultBox.innerHTML = ""; // ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢
              const sections = response.split(/ã€(.+?)ã€‘/g);

              for (let i = 1; i < sections.length; i += 2) {
                const title = sections[i];
                const content = sections[i + 1];

                const sectionDiv = document.createElement("div");
                sectionDiv.classList.add("mb-4");

                const heading = document.createElement("h4");
                heading.textContent = `ğŸ”¹ ${title}`;
                heading.classList.add("fw-bold");

                const body = document.createElement("p");
                body.textContent = content.trim();
                body.classList.add("text-muted");

                sectionDiv.appendChild(heading);
                sectionDiv.appendChild(body);

                resultBox.appendChild(sectionDiv);
              }

              // è¨ºæ–­å¾Œã«PDFãƒœã‚¿ãƒ³è¡¨ç¤º(ä¸€æ—¦å°å°)
              // document.getElementById("downloadPdfBtn").classList.remove("d-none");
            }
          })
          .withFailureHandler(function (error) {
            console.error("å ã„ã‚¨ãƒ©ãƒ¼:", error);
            resultBox.innerText = "ã†ã¾ãå ã„ãŒã§ãã¾ã›ã‚“ã§ã—ãŸğŸ’¦ ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          })
          .getUranaiResult(data);

          if (!submitBtnRegistered) {
            document.getElementById("submitKanjiBtn").addEventListener("click", function () {
              const strokes = parseInt(document.getElementById("kanjiStrokeInput").value, 10);
              const errorMsg = document.getElementById("strokeErrorMsg");

              if (!isNaN(strokes) && strokes > 0) {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                if (errorMsg) errorMsg.classList.add("d-none");

                google.script.run
                  .withSuccessHandler(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById("kanjiModal"));
                    modal.hide();
                    runUranai(); // å†è¨ºæ–­
                  })
                  .recordMissingKakusuu(pendingKanji, strokes);
              } else {
                if (errorMsg) {
                  errorMsg.innerText = "æœ‰åŠ¹ãªç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                  errorMsg.classList.remove("d-none");
                } else {
                  alert("æœ‰åŠ¹ãªç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); // å¿µã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }
              }
            });
            submitBtnRegistered = true;
          }
      }
    </script>

    <!-- æœªç™»éŒ²æ¼¢å­—ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="kanjiModal" tabindex="-1" aria-labelledby="kanjiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="kanjiModalLabel">æœªç™»éŒ²ã®æ¼¢å­—ãŒã‚ã‚Šã¾ã™</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
          </div>
          <div class="modal-body">
            <p id="kanjiPrompt"></p>
            <input type="number" id="kanjiStrokeInput" class="form-control" placeholder="ç”»æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
            <!-- ğŸ”½ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ -->
            <div id="strokeErrorMsg" class="alert alert-danger mt-2 d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn btn-primary" id="submitKanjiBtn">é€ä¿¡ã—ã¦å†è¨ºæ–­</button>
          </div>
        </div>
      </div>
    </div>
    <!-- PDFå‡¦ç†ã€€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ï¼ˆPDFå‡¦ç†ã¯ã†ã¾ãã„ã‹ãªã„ã®ã§å°å°ï¼‰
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const pdfBtn = document.getElementById("downloadPdfBtn");
        if (pdfBtn) {
          pdfBtn.addEventListener("click", () => {
            const resultContent = document.getElementById("result");

            // PDFç”¨ã«ä¸€æ™‚çš„ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
            const originalFontSize = resultContent.style.fontSize;
            const originalPadding = resultContent.style.padding;
            resultContent.style.fontSize = "0.95rem";
            resultContent.style.padding = "8px";

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const fileName = `${yyyy}-${mm}-${dd}_uranai.pdf`;

            const opt = {
              margin: 5, // ä½™ç™½ã‚’5mmã«
              filename: fileName,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 1.0, useCORS: true }, // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’1.0ã«
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait'},
              pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            html2pdf()
              .set(opt)
              .from(resultContent)
              .save()
              .then(() => {
                resultContent.style.fontSize = originalFontSize;
                resultContent.style.padding = originalPadding;
                alert("ğŸ”® PDFã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
              })
              .catch((err) => {
                resultContent.style.fontSize = originalFontSize;
                resultContent.style.padding = originalPadding;
                console.error("PDFä½œæˆã‚¨ãƒ©ãƒ¼:", err);
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦ ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
              });
          });
        }
      });
    </script>
   -->
  </body>
</html>
