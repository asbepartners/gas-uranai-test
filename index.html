<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

    <!-- flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <!-- Bootstrap JS（モーダルなどに必要）-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- flatpickr 初期化 -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        <!-- flatpickr.localize(flatpickr.l10ns.ja); -->
        flatpickr.localize(flatpickr.l10ns.ja);
        flatpickr("#birth", {
          dateFormat: "Y-m-d",
          maxDate: "today"
        });
      });
    </script>

    <style>
      body {
        background: #f5f2fa;
        font-family: "Helvetica Neue", sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 640px;
        background: #ffffff;
        padding: 2rem;
        margin: 2rem auto;
        border-radius: 1rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }
      h2 {
        font-weight: bold;
        color: #5c4b8a;
        font-size: 1.8rem;
        text-align: center;
      }
      .form-label {
        font-weight: 500;
        font-size: 1rem;
      }
      .form-control,
      .form-select {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
      }
      .btn-purple {
        background-color: #9b59b6;
        border: none;
        color: white;
        font-size: 1.2rem;
        padding: 0.9rem;
        border-radius: 0.5rem;
      }
      .btn-purple:hover {
        background-color: #8e44ad;
        color: #ffe8b5;
      }
      #result {
        white-space: pre-wrap;
        min-height: 4em;
        font-size: 1rem;
      }
      .alert-custom {
        background: #fdf8f3;
        border-radius: 0.75rem;
        border: 1px solid #e6ddd5;
        padding: 1.25rem;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2 class="mb-4">-- 今週のあなた --</h2>

      <div class="mb-3">
        <label for="lastName" class="form-label">姓</label>
        <input type="text" id="lastName" class="form-control" placeholder="例：山田" />
      </div>

      <div class="mb-3">
        <label for="firstName" class="form-label">名</label>
        <input type="text" id="firstName" class="form-control" placeholder="例：花子" />
      </div>

      <div class="mb-3">
        <label for="birth" class="form-label">生年月日</label>
        <input type="text" id="birth" class="form-control" placeholder="クリックして選択" />
      </div>

      <div class="mb-3">
        <label for="gender" class="form-label">性別</label>
        <select id="gender" class="form-select">
          <option value="女性">女性</option>
          <option value="男性">男性</option>
          <option value="その他">その他</option>
        </select>
      </div>

      <button onclick="runUranai()" class="btn btn-purple w-100">診断スタート</button>

      <div id="result" class="mt-4 alert alert-custom"></div>
    </div>

    <!-- 占いロジック -->
    <script>
      let pendingKanji = "";
      let retryFlag = false;
      let submitBtnRegistered = false;

      function runUranai() {

        lastName= document.getElementById("lastName").value.trim();
        firstName= document.getElementById("firstName").value.trim();
        birth= document.getElementById("birth").value.trim();
        gender= document.getElementById("gender").value.trim();

        const resultBox = document.getElementById("result");
        if (!resultBox) {
          console.error("⚠️ #result 要素が見つかりません");
          return;
        }
        // 必須項目チェック
        if (!lastName || !firstName || !birth) {
          resultBox.innerText = "⚠️ 姓・名・生年月日はすべて入力してください。";
          return;
        }
        resultBox.innerText = "占い中…しばらくお待ちください⏳";

        const data ={
          lastName,
          firstName,
          birth,
          gender
        }

        google.script.run
          .withSuccessHandler(function (response) {
            console.log("🔍 response:", response);
            if (typeof response === "object" && response.success === false) {
              if (response.type === "missingKanji") {
                pendingKanji = response.kanji;
                document.getElementById("kanjiPrompt").innerText = `漢字「${pendingKanji}」の画数を入力してください：`;
                document.getElementById("kanjiStrokeInput").value = "";

                const modal = new bootstrap.Modal(document.getElementById("kanjiModal"));
                modal.show();
              } else {
                resultBox.innerText = `⚠️ ${response.message}`;
              }
            } else {
              resultBox.innerText = response;
            }
          })
          .withFailureHandler(function (error) {
            console.error("占いエラー:", error);
            resultBox.innerText = "うまく占いができませんでした💦 もう一度お試しください。";
          })
          .getUranaiResult(data);

          if (!submitBtnRegistered) {
            document.getElementById("submitKanjiBtn").addEventListener("click", function () {
              const strokes = parseInt(document.getElementById("kanjiStrokeInput").value, 10);
              const errorMsg = document.getElementById("strokeErrorMsg");

              if (!isNaN(strokes) && strokes > 0) {
                // エラーメッセージを非表示にする
                if (errorMsg) errorMsg.classList.add("d-none");

                google.script.run
                  .withSuccessHandler(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById("kanjiModal"));
                    modal.hide();
                    runUranai(); // 再診断
                  })
                  .recordMissingKakusuu(pendingKanji, strokes);
              } else {
                if (errorMsg) {
                  errorMsg.innerText = "有効な画数を入力してください。";
                  errorMsg.classList.remove("d-none");
                } else {
                  alert("有効な画数を入力してください。"); // 念のためフォールバック
                }
              }
            });
            submitBtnRegistered = true;
          }
      }
    </script>

    <!-- 未登録漢字のモーダル -->
    <div class="modal fade" id="kanjiModal" tabindex="-1" aria-labelledby="kanjiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="kanjiModalLabel">未登録の漢字があります</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
          </div>
          <div class="modal-body">
            <p id="kanjiPrompt"></p>
            <input type="number" id="kanjiStrokeInput" class="form-control" placeholder="画数を入力してください" />
            <!-- 🔽 エラーメッセージ表示用 -->
            <div id="strokeErrorMsg" class="alert alert-danger mt-2 d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <button type="button" class="btn btn-primary" id="submitKanjiBtn">送信して再診断</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
